<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Stream 2 Night</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(to bottom, #1b103f, #090d28);
    }
    .tab-button {
      padding: 0.75rem 1.5rem;
      border-radius: 9999px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 0 0 1px rgba(255,255,255,0.1);
      font-size: 1.1rem;
    }
    .active-tab {
      background: linear-gradient(to right, #7f5af0, #2cb67d);
      color: white;
      box-shadow: 0 0 10px rgba(127, 90, 240, 0.6);
    }
    .inactive-tab {
      background-color: #2e2e3a;
      color: #a0aec0;
    }
    .inactive-tab:hover {
      background-color: #3a3a4d;
      color: #ffffff;
    }
    .flag-tab {
      border-radius: 9999px;
      padding: 0.5rem 0.9rem;
      font-size: 1.85rem;
      background: #222;
      border: 2px solid transparent;
      margin: 0 0.25rem;
      transition: 0.2s;
      box-shadow: 0 2px 12px 0 rgba(90,90,120,0.06);
      outline: none;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
      height: 3.2rem;
      width: 3.7rem;
    }
    .flag-tab.selected {
      background: linear-gradient(to right, #7f5af0, #2cb67d);
      color: white;
      border-color: #fff;
      filter: brightness(1.15) drop-shadow(0 2px 8px #7f5af088);
    }
    .flag-img {
      width: 2.2rem;
      height: 1.6rem;
      border-radius: 0.4rem;
      object-fit: cover;
      display: block;
    }
    @media (max-width: 480px) {
      .flag-tab { padding: 0.4rem 0.6rem; font-size: 1.15rem; height: 2.2rem; width: 2.6rem; }
      .flag-img { width: 1.2rem; height: 0.9rem; }
      .tab-button { padding: 0.45rem 0.7rem; font-size: 0.93rem;}
    }
  </style>
</head>
<body class="text-white">
  <section class="text-center py-20 px-6">
    <h1 class="text-6xl font-bold mb-4 leading-tight bg-gradient-to-r from-purple-500 via-pink-500 to-red-500 bg-clip-text text-transparent">Stream 2 Night</h1>
    <p class="text-xl text-gray-300 mb-6">Smarter streaming, simplified.</p>
    <!-- Flag Tabs -->
    <div class="mb-6 flex justify-center gap-3">
      <button id="regionUK" class="flag-tab selected" title="United Kingdom" aria-label="United Kingdom">
        <img src="https://hatscripts.github.io/circle-flags/flags/gb.svg" alt="UK" class="flag-img" />
      </button>
      <button id="regionUS" class="flag-tab" title="United States" aria-label="United States">
        <img src="https://hatscripts.github.io/circle-flags/flags/us.svg" alt="US" class="flag-img" />
      </button>
    </div>
    <!-- Media Type Tabs -->
    <div class="mb-8 flex justify-center gap-4">
      <button id="allTab" class="tab-button active-tab">All</button>
      <button id="movieTab" class="tab-button inactive-tab">Movies</button>
      <button id="tvTab" class="tab-button inactive-tab">Series</button>
    </div>
    <input id="searchInput" type="text" autocomplete="off" placeholder="Search for a movie or series..." class="text-black w-full max-w-md px-4 py-2 rounded mb-8" />
    <div id="searchResults" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4"></div>
    <button id="showMoreBtn" class="mt-6 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded">Show More</button>
  </section>
  <img src="https://em-content.zobj.net/source/microsoft-teams/337/fox_1f98a.png" alt="Fox" class="fixed top-4 right-4 h-16 w-16 z-50">
  <footer class="text-center p-4 text-gray-400">
    This site uses the TMDb and Watchmode APIs but is not endorsed or certified by either.
  </footer>
  <script>
    const tmdbApiKey = '2acda6d77609c7c9b6bce9bdf4e5271f';
    const watchmodeApiKey = 'Obbabfda4fmsh11a51996ff09aeap16c8a6jsn6ee377acda63';
    let fullResults = [];
    let displayedCount = 0;
    let currentPage = 1;
    let currentQuery = '';
    let isSearchMode = false;
    let currentType = 'all';
    let currentRegion = 'GB';
    let isLoadingMore = false;
    let shownIDs = new Set();
    let debounceTimeout = null;
    let searchVersion = 0;

    function getPopularUrl() {
      if (currentType === 'tv') {
        return [`https://api.themoviedb.org/3/tv/popular?api_key=${tmdbApiKey}&language=en-${currentRegion}&page=${currentPage}`];
      } else if (currentType === 'movie') {
        return [`https://api.themoviedb.org/3/movie/popular?api_key=${tmdbApiKey}&language=en-${currentRegion}&page=${currentPage}`];
      } else {
        if (currentPage === 1) {
          return [
            `https://api.themoviedb.org/3/movie/popular?api_key=${tmdbApiKey}&language=en-${currentRegion}&page=1`,
            `https://api.themoviedb.org/3/tv/popular?api_key=${tmdbApiKey}&language=en-${currentRegion}&page=1`
          ];
        } else {
          return [`https://api.themoviedb.org/3/movie/popular?api_key=${tmdbApiKey}&language=en-${currentRegion}&page=${currentPage}`];
        }
      }
    }

    async function fetchPopular() {
      let urls = getPopularUrl();
      fullResults = [];
      shownIDs.clear();
      for (const url of urls) {
        const res = await fetch(url);
        const data = await res.json();
        if (data.results) {
          fullResults = fullResults.concat(data.results.map(item => {
            if (url.includes('/tv/')) item.media_type = 'tv';
            else item.media_type = 'movie';
            return item;
          }));
        }
      }
    }

    async function searchTMDB(query, type) {
      let url = `https://api.themoviedb.org/3/search/${type === 'all' ? 'multi' : (type === 'movie' ? 'movie' : 'tv')}?api_key=${tmdbApiKey}&language=en-${currentRegion}&query=${encodeURIComponent(query)}&page=${currentPage}`;
      const res = await fetch(url);
      const data = await res.json();
      if (data.results) {
        fullResults = data.results.map(item => {
          if (type === 'all' && !item.media_type) item.media_type = item.title ? 'movie' : 'tv';
          return item;
        });
      }
    }

    async function fetchAvailability(id, mediaType, title) {
      const type = mediaType === 'tv' ? 'tv' : 'movie';
      try {
        const tmdbRes = await fetch(`https://api.themoviedb.org/3/${type}/${id}/watch/providers?api_key=${tmdbApiKey}`);
        const tmdbData = await tmdbRes.json();
        const countryData = tmdbData.results?.[currentRegion];

        let stream = '';
        let buy = '';

        if (countryData) {
          const render = (items) => items.map(p => `<img src='https://image.tmdb.org/t/p/w45${p.logo_path}' alt='${p.provider_name}' title='${p.provider_name}' class='inline-block h-8 mx-2'>`).join('');
          stream = countryData.flatrate ? render(countryData.flatrate) : '';
          buy = countryData.buy ? render(countryData.buy) : '';
        }

        if (!stream && !buy && title) {
          const searchRes = await fetch(`https://watchmode.p.rapidapi.com/search/?search_value=${encodeURIComponent(title)}&search_type=1`, {
            method: 'GET',
            headers: {
              'X-RapidAPI-Key': watchmodeApiKey,
              'X-RapidAPI-Host': 'watchmode.p.rapidapi.com'
            }
          });
          const searchData = await searchRes.json();
          const match = searchData.title_results?.find(r => r.name.toLowerCase() === title.toLowerCase());
          if (match) {
            const sourceRes = await fetch(`https://watchmode.p.rapidapi.com/title/${match.id}/sources/`, {
              method: 'GET',
              headers: {
                'X-RapidAPI-Key': watchmodeApiKey,
                'X-RapidAPI-Host': 'watchmode.p.rapidapi.com'
              }
            });
            const sourceData = await sourceRes.json();
            const watchmodeLogos = sourceData.filter(s => s.type === 'sub' || s.type === 'buy')
              .map(s => `<div class='text-sm text-white border px-2 py-1 rounded mx-1'>${s.name}</div>`)
              .join('');
            stream = watchmodeLogos;
          }
        }

        if (!stream && !buy) return null;
        return { stream, buy };

      } catch (err) {
        console.error('Error fetching availability:', err);
        return null;
      }
    }

    function clearResults() {
      document.getElementById('searchResults').innerHTML = '';
      displayedCount = 0;
      shownIDs.clear();
    }

    // Mainstream filter: Only for "Popular" (not search)
    function deduplicateAndSort(input, isPopular) {
      const normalize = (t) => t.toLowerCase().replace(/^the\s+/i, '');
      const queryNorm = normalize(input.trim().toLowerCase());
      const seenTitles = new Set();

      let arr = fullResults.filter(item => {
        if (!item) return false;
        const title = (item.title || item.name || '').toLowerCase();
        if (seenTitles.has(title)) return false;
        seenTitles.add(title);

        // For "popular", filter by vote_count; for search, show all
        if (isPopular && (item.vote_count || 0) < 100) return false;
        if (currentType === 'all') return true;
        return item.media_type === currentType;
      }).sort((a, b) => {
        const aTitle = normalize(a.title || a.name || '');
        const bTitle = normalize(b.title || b.name || '');

        // Exact match, then prefix, then vote count, then popularity
        const aExact = aTitle === queryNorm;
        const bExact = bTitle === queryNorm;
        if (aExact && !bExact) return -1;
        if (!aExact && bExact) return 1;

        const aStarts = aTitle.startsWith(queryNorm);
        const bStarts = bTitle.startsWith(queryNorm);
        if (aStarts && !bStarts) return -1;
        if (!aStarts && bStarts) return 1;

        if ((b.vote_count || 0) !== (a.vote_count || 0)) {
          return (b.vote_count || 0) - (a.vote_count || 0);
        }
        return (b.popularity || 0) - (a.popularity || 0);
      });

      return arr;
    }

    async function renderBatch(batch) {
      const container = document.getElementById('searchResults');
      for (const item of batch) {
        if (!item || shownIDs.has(item.id)) continue;
        if (currentType !== 'all' && item.media_type !== currentType) continue;
        shownIDs.add(item.id);

        const title = item.title || item.name || 'Untitled';
        const poster = item.poster_path ? `https://image.tmdb.org/t/p/w500${item.poster_path}` : '';
        const availability = await fetchAvailability(item.id, item.media_type, title);
        const card = document.createElement('div');
        card.className = 'bg-gray-800 p-4 rounded-lg shadow';
        if (!availability) {
          card.innerHTML = `
            <img src="${poster}" alt="${title}" class="rounded mb-4">
            <h3 class="text-lg font-semibold">${title}</h3>
            <div class="text-sm text-yellow-400 mt-4">Not yet available to stream or buy in selected region.</div>
          `;
        } else {
          card.innerHTML = `
            <img src="${poster}" alt="${title}" class="rounded mb-4">
            <h3 class="text-lg font-semibold">${title}</h3>
            <div class="text-sm text-gray-300">
              ${availability.stream ? `<div class='mt-2'>Stream on:<div class='flex flex-wrap justify-center'>${availability.stream}</div></div>` : ''}
              ${availability.buy ? `<div class='mt-4'>Buy on:<div class='flex flex-wrap justify-center'>${availability.buy}</div></div>` : ''}
            </div>
          `;
        }
        container.appendChild(card);
        displayedCount++;
      }
    }

    async function showMore() {
      if (isLoadingMore) return; // Prevent rapid spamming
      isLoadingMore = true;
      document.getElementById('showMoreBtn').disabled = true;

      let batch = fullResults.slice(displayedCount, displayedCount + 12).filter(item => !shownIDs.has(item.id));
      if (batch.length === 0 && (isSearchMode || currentPage === 1)) {
        currentPage++;
        if (isSearchMode) {
          await searchTMDB(currentQuery, currentType);
        } else {
          await fetchPopular();
          fullResults = deduplicateAndSort(document.getElementById('searchInput').value, true);
        }
        batch = fullResults.slice(displayedCount, displayedCount + 12).filter(item => !shownIDs.has(item.id));
      }
      await renderBatch(batch);

      isLoadingMore = false;
      document.getElementById('showMoreBtn').disabled = false;
    }

    function setActiveTab(tab) {
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active-tab', 'inactive-tab'));
      tab.classList.add('active-tab');
    }

    function setRegionButton(regionBtn) {
      document.querySelectorAll('.flag-tab').forEach(btn => btn.classList.remove('selected'));
      regionBtn.classList.add('selected');
    }

    async function runSearchDebounced(input, ver) {
      isSearchMode = !!input.trim();
      currentQuery = input.trim();
      currentPage = 1;
      fullResults = [];
      displayedCount = 0;
      clearResults();

      if (isSearchMode) {
        await searchTMDB(input, currentType);
        if (ver !== searchVersion) return; // Only show latest search
        fullResults = deduplicateAndSort(input, false);
      } else {
        await fetchPopular();
        fullResults = deduplicateAndSort('', true);
      }
      await showMore();
    }

    function debouncedSearch(input) {
      searchVersion++;
      let thisVer = searchVersion;
      clearTimeout(debounceTimeout);
      debounceTimeout = setTimeout(() => runSearchDebounced(input, thisVer), 250);
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await fetchPopular();
      fullResults = deduplicateAndSort('', true);
      await showMore();

      document.getElementById('searchInput').addEventListener('input', (e) => {
        debouncedSearch(e.target.value);
      });

      document.getElementById('movieTab').addEventListener('click', () => {
        currentType = 'movie';
        setActiveTab(document.getElementById('movieTab'));
        debouncedSearch(document.getElementById('searchInput').value);
      });

      document.getElementById('tvTab').addEventListener('click', () => {
        currentType = 'tv';
        setActiveTab(document.getElementById('tvTab'));
        debouncedSearch(document.getElementById('searchInput').value);
      });

      document.getElementById('allTab').addEventListener('click', () => {
        currentType = 'all';
        setActiveTab(document.getElementById('allTab'));
        debouncedSearch(document.getElementById('searchInput').value);
      });

      document.getElementById('regionUK').addEventListener('click', () => {
        currentRegion = 'GB';
        setRegionButton(document.getElementById('regionUK'));
        debouncedSearch(document.getElementById('searchInput').value);
      });

      document.getElementById('regionUS').addEventListener('click', () => {
        currentRegion = 'US';
        setRegionButton(document.getElementById('regionUS'));
        debouncedSearch(document.getElementById('searchInput').value);
      });

      document.getElementById('showMoreBtn').addEventListener('click', async () => {
        await showMore();
      });
    });
  </script>
</body>
</html>



