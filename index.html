<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Stream 2 Night</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body { background: linear-gradient(to bottom, #1b103f, #090d28); }
    .tab-button { padding: 0.75rem 1.5rem; border-radius: 9999px; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 0 0 1px rgba(255,255,255,0.1); font-size: 1.1rem; }
    .active-tab { background: linear-gradient(to right, #7f5af0, #2cb67d); color: white; box-shadow: 0 0 10px rgba(127, 90, 240, 0.6);}
    .inactive-tab { background-color: #2e2e3a; color: #a0aec0;}
    .inactive-tab:hover { background-color: #3a3a4d; color: #ffffff;}
    .flag-tab { border-radius: 9999px; padding: 0.5rem 0.9rem; font-size: 1.85rem; background: #222; border: 2px solid transparent; margin: 0 0.25rem; transition: 0.2s; box-shadow: 0 2px 12px 0 rgba(90,90,120,0.06); outline: none; display: flex; align-items: center; justify-content: center; line-height: 1; height: 3.2rem; width: 3.7rem; }
    .flag-tab.selected { background: linear-gradient(to right, #7f5af0, #2cb67d); color: white; border-color: #fff; filter: brightness(1.15) drop-shadow(0 2px 8px #7f5af088);}
    .flag-img { width: 2.2rem; height: 1.6rem; border-radius: 0.4rem; object-fit: cover; display: block;}
    .wild-btn { margin-left: 0.75rem; background: linear-gradient(to right, #ffde57, #fc7e1e); color: #1b103f; font-weight: 700; border-radius: 2rem; padding: 0.7rem 1.3rem; font-size: 1.2rem; box-shadow: 0 2px 10px #0003; border: none; transition: 0.2s; }
    .wild-btn:hover { background: linear-gradient(to right, #fc7e1e, #ffde57); color: #111; }
    .overlay-spin {
      position: fixed; z-index: 100; inset: 0; background: rgba(26,18,48,0.94); display: flex; align-items: center; justify-content: center; flex-direction: column;
      animation: fadeIn 0.4s;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .spin-wheel {
      border: 8px solid #fff;
      border-radius: 50%;
      width: 130px; height: 130px;
      border-top: 8px solid #ffde57;
      border-right: 8px solid #2cb67d;
      border-bottom: 8px solid #7f5af0;
      border-left: 8px solid #fc7e1e;
      animation: spin 1s linear infinite;
      margin-bottom: 1.3rem;
    }
    .wild-card-center {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 350px;
      grid-column: 1 / -1;
    }
    @media (max-width: 1024px) {
      .wild-card-center { min-height: 220px; }
    }
    .border-yellow-400 {
      border-color: #ffde57 !important;
      box-shadow: 0 0 14px #ffde5744, 0 0 30px #ffde5770 !important;
    }
    .free-badge {
      background: linear-gradient(90deg, #ffe178 60%, #fc7e1e 100%);
      color: #1b103f;
      font-weight: bold;
      border-radius: 9999px;
      padding: 0.33rem 1.1rem;
      font-size: 1.05rem;
      margin-top: 0.7rem;
      margin-bottom: 0.9rem;
      display: inline-block;
      box-shadow: 0 2px 12px #ffde5740;
      letter-spacing: 0.06em;
      border: 2.5px solid #ffde57;
      text-shadow: 0 1px 6px #fff6, 0 0 10px #fc7e1e44;
    }
    .toggle-free.active {
      background: linear-gradient(to right, #ffe178, #fc7e1e);
      color: #1b103f;
      font-weight: 700;
      box-shadow: 0 2px 10px #ffde574c;
      border: 2.5px solid #ffde57;
    }
    .toggle-free {
      padding: 0.7rem 2.0rem;
      border-radius: 9999px;
      font-weight: 600;
      background: #222;
      color: #ffe178;
      border: 2px solid #ffe178;
      margin-left: 0.5rem;
      font-size: 1.15rem;
      transition: 0.2s;
    }
    .toggle-free:hover {
      background: linear-gradient(to right, #fc7e1e, #ffe178);
      color: #1b103f;
    }
  </style>
</head>
<body class="text-white">
  <section class="text-center py-20 px-6">
    <h1 class="text-6xl font-bold mb-4 leading-tight bg-gradient-to-r from-purple-500 via-pink-500 to-red-500 bg-clip-text text-transparent">Stream 2 Night</h1>
    <p class="text-xl text-gray-300 mb-6">Smarter streaming, simplified.</p>
    <div class="mb-6 flex justify-center gap-3">
      <button id="regionUK" class="flag-tab selected" title="United Kingdom" aria-label="United Kingdom">
        <img src="https://hatscripts.github.io/circle-flags/flags/gb.svg" alt="UK" class="flag-img" />
      </button>
      <button id="regionUS" class="flag-tab" title="United States" aria-label="United States">
        <img src="https://hatscripts.github.io/circle-flags/flags/us.svg" alt="US" class="flag-img" />
      </button>
      <button id="regionCA" class="flag-tab" title="Canada" aria-label="Canada">
        <img src="https://hatscripts.github.io/circle-flags/flags/ca.svg" alt="Canada" class="flag-img" />
      </button>
    </div>
    <div class="mb-8 flex justify-center gap-4">
      <button id="allTab" class="tab-button active-tab">All</button>
      <button id="movieTab" class="tab-button inactive-tab">Movies</button>
      <button id="tvTab" class="tab-button inactive-tab">Series</button>
      <button id="freeToggle" class="toggle-free">Free</button>
    </div>
    <div class="flex justify-center items-center mb-8">
      <input id="searchInput" type="text" autocomplete="off" placeholder="Search for a movie or series..." class="text-black w-full max-w-md px-4 py-2 rounded" />
      <button id="wildBtn" class="wild-btn" title="Spin the wheel for a random pick!">ðŸŽ² Wild Card</button>
    </div>
    <div id="searchResults" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4"></div>
    <button id="showMoreBtn" class="mt-6 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded">Show More</button>
  </section>
  <img src="https://em-content.zobj.net/source/microsoft-teams/337/otter_1f9a6.png" alt="Otter" class="fixed top-4 right-4 h-16 w-16 z-50">
  <footer class="text-center p-4 text-gray-400">
    This site uses the TMDb and Watchmode APIs but is not endorsed or certified by either.
  </footer>
  <div id="wildOverlay" style="display:none;" class="overlay-spin">
    <div class="spin-wheel"></div>
    <div class="text-xl font-bold mt-2">Picking something great for youâ€¦</div>
  </div>
  <script>
    const tmdbApiKey = '2acda6d77609c7c9b6bce9bdf4e5271f';
    const watchmodeApiKey = 'Obbabfda4fmsh11a51996ff09aeap16c8a6jsn6ee377acda63';
    const PLEX_SOURCE_ID = 203;

    let currentType = 'all'; // all | movie | tv
    let currentRegion = 'GB';
    let currentQuery = '';
    let currentPage = 1;
    let results = [];
    let isLoading = false;
    let isFreeFilter = false;
    let freeQuery = '';
    let freePage = 1;
    let freeCache = [];

    function setActiveTab(tab) {
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active-tab', 'inactive-tab'));
      tab.classList.add('active-tab');
    }
    function setRegionButton(regionBtn) {
      document.querySelectorAll('.flag-tab').forEach(btn => btn.classList.remove('selected'));
      regionBtn.classList.add('selected');
    }

    function clearResults() {
      document.getElementById('searchResults').innerHTML = '';
    }

    function getPosterURL(item) {
      if (item.poster) return item.poster;
      if (item.poster_path) return `https://image.tmdb.org/t/p/w500${item.poster_path}`;
      return '';
    }
    function getTitle(item) {
      return item.title || item.name || item.original_title || item.original_name || 'Untitled';
    }
    function getYear(item) {
      if (item.year) return item.year;
      if (item.release_date) return (item.release_date + '').slice(0, 4);
      if (item.first_air_date) return (item.first_air_date + '').slice(0, 4);
      return '';
    }

    async function fetchMedia(type, query, page) {
      let arr = [];
      let endpoints = getEndpoint(type, query, page);
      if (Array.isArray(endpoints)) {
        for (let ep of endpoints) {
          let res = await fetch(ep);
          let data = await res.json();
          arr = arr.concat((data.results || []).map(item => {
            if (ep.includes('/tv/')) item.media_type = 'tv';
            else item.media_type = 'movie';
            return item;
          }));
        }
      } else {
        let res = await fetch(endpoints);
        let data = await res.json();
        arr = (data.results || []).map(item => {
          if (!item.media_type) item.media_type = type === 'all' ? (item.title ? 'movie' : 'tv') : type;
          return item;
        });
      }
      return arr;
    }

    function getEndpoint(type, query, page) {
      let base = 'https://api.themoviedb.org/3';
      if (query) {
        if (type === 'movie') return `${base}/search/movie?api_key=${tmdbApiKey}&language=en-${currentRegion}&query=${encodeURIComponent(query)}&page=${page}`;
        if (type === 'tv') return `${base}/search/tv?api_key=${tmdbApiKey}&language=en-${currentRegion}&query=${encodeURIComponent(query)}&page=${page}`;
        return `${base}/search/multi?api_key=${tmdbApiKey}&language=en-${currentRegion}&query=${encodeURIComponent(query)}&page=${page}`;
      } else {
        if (type === 'movie') return `${base}/movie/popular?api_key=${tmdbApiKey}&language=en-${currentRegion}&page=${page}`;
        if (type === 'tv') return `${base}/tv/popular?api_key=${tmdbApiKey}&language=en-${currentRegion}&page=${page}`;
        return [
          `${base}/movie/popular?api_key=${tmdbApiKey}&language=en-${currentRegion}&page=${page}`,
          `${base}/tv/popular?api_key=${tmdbApiKey}&language=en-${currentRegion}&page=${page}`
        ];
      }
    }

    // --- WATCHMODE: Fetch free-on-Plex ---
    async function fetchWatchmodeFree(type = 'movie', page = 1, query = '') {
      let url = `https://watchmode.p.rapidapi.com/list-titles/?source_ids=${PLEX_SOURCE_ID}&types=${type}&page=${page}`;
      if (query) url += `&search_field=name&search_value=${encodeURIComponent(query)}`;
      const res = await fetch(url, {
        method: 'GET',
        headers: {
          'X-RapidAPI-Key': watchmodeApiKey,
          'X-RapidAPI-Host': 'watchmode.p.rapidapi.com'
        }
      });
      const data = await res.json();
      return (data.titles || []);
    }

    // For free-on-Plex, always gold outline and badge
    async function renderBatchFree(batch) {
      const container = document.getElementById('searchResults');
      for (const item of batch) {
        const title = getTitle(item);
        const poster = getPosterURL(item);
        const year = getYear(item);
        // Get a direct Plex URL for this item (if not present in the data)
        let plexUrl = item.direct_url || '';
        if (!plexUrl && item.id) {
          plexUrl = await fetchPlexSourceUrl(item.id);
        }
        const card = document.createElement('div');
        card.className = 'bg-gray-800 p-4 rounded-lg shadow border-4 border-yellow-400';
        card.innerHTML = `
          <img src="${poster}" alt="${title}" class="rounded mb-4">
          <h3 class="text-lg font-semibold">${title}</h3>
          <div class="text-sm text-gray-300 mb-2">${year ? year : ''}</div>
          <a href="${plexUrl || '#'}" ${plexUrl ? 'target="_blank" rel="noopener"' : ''} class="free-badge">Free on Plex!</a>
        `;
        container.appendChild(card);
      }
    }

    // For /list-titles, fetch sources to get direct Plex URL if not in item
    async function fetchPlexSourceUrl(title_id) {
      const res = await fetch(`https://watchmode.p.rapidapi.com/title/${title_id}/sources/`, {
        method: 'GET',
        headers: {
          'X-RapidAPI-Key': watchmodeApiKey,
          'X-RapidAPI-Host': 'watchmode.p.rapidapi.com'
        }
      });
      const sources = await res.json();
      const plex = sources.find(s =>
        s.name && s.name.toLowerCase().includes('plex') &&
        (s.type === 'free' || s.type === 'ads')
      );
      return plex ? plex.web_url : '';
    }

    // For TMDb results, no badge or border unless free-on-Plex (but we don't check, as requested)
    async function renderBatchStandard(batch) {
      const container = document.getElementById('searchResults');
      for (const item of batch) {
        const title = getTitle(item);
        const poster = getPosterURL(item);
        const year = getYear(item);
        const card = document.createElement('div');
        card.className = 'bg-gray-800 p-4 rounded-lg shadow';
        card.innerHTML = `
          <img src="${poster}" alt="${title}" class="rounded mb-4">
          <h3 class="text-lg font-semibold">${title}</h3>
          <div class="text-sm text-gray-300 mb-2">${year ? year : ''}</div>
        `;
        container.appendChild(card);
      }
    }

    // Run search for free tab
    async function runFreeTab(isNew = false) {
      if (isNew) {
        freePage = 1;
        freeCache = [];
        clearResults();
      }
      let type = currentType === 'tv' ? 'tv' : 'movie';
      let batch = await fetchWatchmodeFree(type, freePage, freeQuery);
      if (batch.length === 0 && freePage === 1) {
        document.getElementById('searchResults').innerHTML = `<div class="wild-card-center"><div class="text-lg font-bold text-yellow-400">No free ${type === 'movie' ? 'movies' : 'series'} found on Plex${freeQuery ? ' for your search.' : '.'}</div></div>`;
        return;
      }
      freeCache = freeCache.concat(batch);
      await renderBatchFree(batch);
    }

    // Run search for standard tabs (All/Movies/Series)
    async function runStandardTab(isNew = false) {
      if (isNew) {
        currentPage = 1;
        results = [];
        clearResults();
      }
      let arr = await fetchMedia(currentType, currentQuery, currentPage);
      if (isNew) {
        results = arr;
      } else {
        results = results.concat(arr);
      }
      // Only show next 12, then Show More for the rest
      await renderBatchStandard(results.slice((currentPage - 1) * 12, currentPage * 12));
    }

    // ==== UI Events ====
    document.addEventListener('DOMContentLoaded', async () => {
      // Initial load
      await runStandardTab(true);

      // Tabs
      document.getElementById('allTab').onclick = async function () {
        if (currentType !== 'all' || isFreeFilter) {
          setActiveTab(this);
          currentType = 'all';
          isFreeFilter = false;
          document.getElementById('freeToggle').classList.remove('active');
          currentPage = 1;
          currentQuery = '';
          document.getElementById('searchInput').value = '';
          await runStandardTab(true);
        }
      };
      document.getElementById('movieTab').onclick = async function () {
        if (currentType !== 'movie' || isFreeFilter) {
          setActiveTab(this);
          currentType = 'movie';
          isFreeFilter = false;
          document.getElementById('freeToggle').classList.remove('active');
          currentPage = 1;
          currentQuery = '';
          document.getElementById('searchInput').value = '';
          await runStandardTab(true);
        }
      };
      document.getElementById('tvTab').onclick = async function () {
        if (currentType !== 'tv' || isFreeFilter) {
          setActiveTab(this);
          currentType = 'tv';
          isFreeFilter = false;
          document.getElementById('freeToggle').classList.remove('active');
          currentPage = 1;
          currentQuery = '';
          document.getElementById('searchInput').value = '';
          await runStandardTab(true);
        }
      };

      // Free filter toggle
      const freeToggleBtn = document.getElementById('freeToggle');
      freeToggleBtn.onclick = async function () {
        isFreeFilter = !isFreeFilter;
        freeToggleBtn.classList.toggle('active', isFreeFilter);
        freeQuery = '';
        document.getElementById('searchInput').value = '';
        clearResults();
        if (isFreeFilter) {
          await runFreeTab(true);
        } else {
          await runStandardTab(true);
        }
      };

      // Region
      document.getElementById('regionUK').onclick = async function () {
        if (currentRegion !== 'GB') {
          setRegionButton(this);
          currentRegion = 'GB';
          if (isFreeFilter) {
            await runFreeTab(true);
          } else {
            await runStandardTab(true);
          }
        }
      };
      document.getElementById('regionUS').onclick = async function () {
        if (currentRegion !== 'US') {
          setRegionButton(this);
          currentRegion = 'US';
          if (isFreeFilter) {
            await runFreeTab(true);
          } else {
            await runStandardTab(true);
          }
        }
      };
      document.getElementById('regionCA').onclick = async function () {
        if (currentRegion !== 'CA') {
          setRegionButton(this);
          currentRegion = 'CA';
          if (isFreeFilter) {
            await runFreeTab(true);
          } else {
            await runStandardTab(true);
          }
        }
      };

      // Search
      document.getElementById('searchInput').addEventListener('input', async function (e) {
        if (isFreeFilter) {
          freeQuery = e.target.value;
          freePage = 1;
          freeCache = [];
          clearResults();
          await runFreeTab(true);
        } else {
          currentQuery = e.target.value;
          currentPage = 1;
          results = [];
          clearResults();
          await runStandardTab(true);
        }
      });

      // Show More
      document.getElementById('showMoreBtn').onclick = async function () {
        if (isFreeFilter) {
          freePage++;
          await runFreeTab(false);
        } else {
          currentPage++;
          await runStandardTab(false);
        }
      };

      // Wild Card
      document.getElementById('wildBtn').onclick = async function () {
        document.getElementById('wildOverlay').style.display = "flex";
        let found = null;
        if (isFreeFilter) {
          let list = freeCache;
          if (list.length === 0) {
            list = await fetchWatchmodeFree(currentType === 'tv' ? 'tv' : 'movie', 1, freeQuery);
          }
          if (list.length > 0) {
            found = list[Math.floor(Math.random() * list.length)];
          }
        } else {
          let arr = results.filter(item => !!getPosterURL(item));
          if (arr.length > 0) {
            found = arr[Math.floor(Math.random() * arr.length)];
          }
        }
        setTimeout(async () => {
          document.getElementById('wildOverlay').style.display = "none";
          clearResults();
          if (found) {
            if (isFreeFilter) {
              await renderBatchFree([found]);
            } else {
              await renderBatchStandard([found]);
            }
          } else {
            document.getElementById('searchResults').innerHTML = `<div class="wild-card-center"><div class="text-lg font-bold text-yellow-400">Sorry, nothing found for your region and settings!</div></div>`;
          }
        }, 1700);
      };
    });
  </script>
</body>
</html>
