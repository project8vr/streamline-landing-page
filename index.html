<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Stream2Night - Wild Cards Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body { background: linear-gradient(to bottom, #1b103f, #090d28); }
    .tab-button, .flag-tab, .provider-btn {
      padding: 0.75rem 1.5rem;
      border-radius: 9999px;
      font-weight: 600;
      transition: all 0.3s;
      margin: 0 0.25rem;
      box-shadow: 0 0 0 1px rgba(255,255,255,0.1);
      cursor: pointer;
    }
    .active-tab, .flag-tab.selected, .provider-btn.selected {
      background: linear-gradient(to right, #7f5af0, #2cb67d);
      color: white;
      box-shadow: 0 0 10px rgba(127, 90, 240, 0.6);
    }
    .inactive-tab, .flag-tab, .provider-btn {
      background-color: #2e2e3a;
      color: #a0aec0;
    }
    .inactive-tab:hover, .flag-tab:hover, .provider-btn:hover {
      background-color: #3a3a4d;
      color: #fff;
    }
    .wild-card-area {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      min-height: 340px; min-width: 220px;
      margin: 1rem auto 0 auto;
    }
    .wild-card-stack {
      position: relative;
      height: 320px; width: 220px;
      margin-bottom: 16px;
    }
    .wild-card {
      position: absolute; top: 0; left: 0;
      width: 220px; height: 320px;
      background: #222345; border-radius: 20px; box-shadow: 0 6px 32px rgba(0,0,0,0.2);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: transform 0.4s cubic-bezier(.68,-0.55,.27,1.55), opacity 0.4s;
      z-index: 5;
    }
    .wild-card.flipped { background: #161825; }
    .wild-card.hide { opacity: 0; pointer-events: none; transform: translateX(500px) rotate(30deg);}
    .wild-card.reject { opacity: 0; pointer-events: none; transform: translateX(-500px) rotate(-30deg);}
    .wild-card img { border-radius: 12px; margin-bottom: 16px; max-width: 180px; max-height: 240px; }
    .shortlist-row {
      display: flex; gap: 24px; justify-content: center; margin-bottom: 32px;
    }
    .shortlist-card {
      background: #181A32; border-radius: 14px; box-shadow: 0 2px 12px #0007; padding: 12px 18px; 
      display: flex; flex-direction: column; align-items: center;
    }
    .shortlist-card img { border-radius: 10px; max-width: 130px; max-height: 180px; }
    .tick-x-btn { 
      background: #fff; border-radius: 9999px; width: 48px; height: 48px; font-size: 2rem; font-weight: 700; 
      color: #111; margin: 0 18px; box-shadow: 0 2px 8px #0004; 
      display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background 0.2s;
    }
    .tick-x-btn:hover { background: #7f5af0; color: #fff;}
    @media (max-width: 640px) {
      .wild-card-area { min-width: unset; }
      .wild-card, .wild-card-stack { width: 95vw; min-width: 0; }
    }
  </style>
</head>
<body class="text-white">
  <section class="text-center py-14 px-2 max-w-5xl mx-auto">
    <h1 class="text-5xl font-extrabold mb-4 bg-gradient-to-r from-purple-500 via-pink-500 to-red-500 bg-clip-text text-transparent">Stream2Night</h1>
    <p class="text-xl text-gray-300 mb-6">Smarter streaming, simplified.</p>
    <div class="mb-6 flex flex-wrap justify-center gap-4">
      <button id="allTab" class="tab-button active-tab">All</button>
      <button id="movieTab" class="tab-button inactive-tab">Movies</button>
      <button id="tvTab" class="tab-button inactive-tab">Series</button>
    </div>
    <div class="mb-6 flex flex-wrap justify-center gap-4">
      <button id="regionUK" class="flag-tab selected" title="United Kingdom" style="font-size:2rem;">🇬🇧</button>
      <button id="regionUS" class="flag-tab" title="United States" style="font-size:2rem;">🇺🇸</button>
      <button id="regionCA" class="flag-tab" title="Canada" style="font-size:2rem;">🇨🇦</button>
    </div>
    <div class="mb-6 flex flex-wrap justify-center gap-2">
      <span class="mr-2 font-semibold text-gray-400">Your services:</span>
      <button class="provider-btn selected" id="provider-netflix">Netflix</button>
      <button class="provider-btn selected" id="provider-prime">Prime Video</button>
      <button class="provider-btn selected" id="provider-disney">Disney+</button>
      <button class="provider-btn selected" id="provider-hulu">Hulu</button>
      <button class="provider-btn selected" id="provider-apple">Apple TV+</button>
    </div>
    <div class="flex flex-wrap items-center justify-center gap-4 mb-10">
      <input id="searchInput" type="text" placeholder="Search for a movie or series..." class="text-black w-full max-w-md px-4 py-2 rounded" />
      <button id="wildBtn" class="ml-4 py-2 px-7 bg-pink-600 hover:bg-pink-700 font-bold rounded-full shadow-lg transition-all">Wild Cards 🎲</button>
    </div>
    <div id="wildArea" class="wild-card-area hidden">
      <div class="shortlist-row" id="shortlistRow"></div>
      <div class="wild-card-stack" id="wildStack"></div>
    </div>
    <div id="mainResults" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4"></div>
    <button id="showMoreBtn" class="mt-8 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded">Show More</button>
  </section>
  <img src="https://em-content.zobj.net/source/microsoft-teams/337/hedgehog_1f994.png" alt="Hedgehog" class="fixed top-4 right-4 h-16 w-16 z-50">
  <footer class="text-center p-4 text-gray-400">This site uses the TMDb and Watchmode APIs but is not endorsed or certified by either.</footer>

<script>
const tmdbApiKey = '2acda6d77609c7c9b6bce9bdf4e5271f';
const watchmodeApiKey = 'Obbabfda4fmsh11a51996ff09aeap16c8a6jsn6ee377acda63';

let currentType = 'all', currentRegion = 'GB', currentQuery = '', currentPage = 1, isLoading = false, showMoreCount = 0, maxShowMore = 4;
let results = [];
let selectedProviders = ['netflix','prime','disney','hulu','apple'];
const providerMap = {
  netflix: 'Netflix', prime: 'Prime Video', disney: 'Disney+', hulu: 'Hulu', apple: 'Apple TV+'
};
const regionMap = { 'regionUK': 'GB', 'regionUS': 'US', 'regionCA': 'CA' };

function setActiveTab(tab) {
  document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active-tab', 'inactive-tab'));
  tab.classList.add('active-tab');
}
function setRegionButton(regionBtn) {
  document.querySelectorAll('.flag-tab').forEach(btn => btn.classList.remove('selected'));
  regionBtn.classList.add('selected');
}
function toggleProvider(providerKey, btn) {
  if (selectedProviders.includes(providerKey)) {
    selectedProviders = selectedProviders.filter(p => p !== providerKey);
    btn.classList.remove('selected');
  } else {
    selectedProviders.push(providerKey);
    btn.classList.add('selected');
  }
  runSearch(true);
}
function filterByProvider(availability) {
  if (!availability) return false;
  // Only allow if at least one streaming service matches
  return selectedProviders.some(prov => (availability.stream || '').toLowerCase().includes(providerMap[prov].toLowerCase()));
}
function deduplicateAndSort(arr, query = '') {
  const seen = new Set();
  const norm = t => t?.toLowerCase().replace(/^the\s+/, '');
  return arr.filter(x => {
    let t = norm(x.title || x.name || '');
    if (seen.has(t)) return false;
    seen.add(t); return true;
  }).sort((a, b) => (b.popularity || b.vote_count || 0) - (a.popularity || a.vote_count || 0));
}

// --- API Fetching ---
async function fetchMedia(type, query, page) {
  let url = '', data = [];
  if (!query) {
    url = `https://api.themoviedb.org/3/${type === 'tv' ? 'tv/popular' : type === 'movie' ? 'movie/popular' : 'trending/all/week'}?api_key=${tmdbApiKey}&language=en-US&page=${page}`;
    const res = await fetch(url);
    const json = await res.json();
    data = json.results || [];
  } else {
    url = `https://api.themoviedb.org/3/search/${type === 'tv' ? 'tv' : type === 'movie' ? 'movie' : 'multi'}?api_key=${tmdbApiKey}&language=en-US&query=${encodeURIComponent(query)}&page=${page}`;
    const res = await fetch(url);
    const json = await res.json();
    data = json.results || [];
  }
  return deduplicateAndSort(data, query);
}

async function fetchAvailability(id, mediaType, title) {
  let type = mediaType === 'tv' ? 'tv' : 'movie';
  try {
    // Try TMDB first
    let tmdbUrl = `https://api.themoviedb.org/3/${type}/${id}/watch/providers?api_key=${tmdbApiKey}`;
    const tmdbRes = await fetch(tmdbUrl);
    const tmdbData = await tmdbRes.json();
    const region = currentRegion;
    const gb = tmdbData.results?.[region];

    let stream = '', buy = '';

    if (gb) {
      const render = (items) => items.map(p => `<img src='https://image.tmdb.org/t/p/w45${p.logo_path}' alt='${p.provider_name}' title='${p.provider_name}' class='inline-block h-8 mx-2'>`).join('');
      stream = gb.flatrate ? render(gb.flatrate) : '';
      buy = gb.buy ? render(gb.buy) : '';
    }

    // Try Watchmode as backup if TMDB fails
    if (!stream && !buy && title) {
      let searchRes = await fetch(`https://watchmode.p.rapidapi.com/search/?search_value=${encodeURIComponent(title)}&search_type=1`, {
        method: 'GET',
        headers: { 'X-RapidAPI-Key': watchmodeApiKey, 'X-RapidAPI-Host': 'watchmode.p.rapidapi.com' }
      });
      let searchData = await searchRes.json();
      const match = searchData.title_results?.find(r => r.name.toLowerCase() === title.toLowerCase());
      if (match) {
        let sourceRes = await fetch(`https://watchmode.p.rapidapi.com/title/${match.id}/sources/`, {
          method: 'GET',
          headers: { 'X-RapidAPI-Key': watchmodeApiKey, 'X-RapidAPI-Host': 'watchmode.p.rapidapi.com' }
        });
        let sourceData = await sourceRes.json();
        const logos = sourceData.filter(s => s.type === 'sub' || s.type === 'buy')
          .map(s => `<div class='text-sm text-white border px-2 py-1 rounded mx-1'>${s.name}</div>`).join('');
        stream = logos;
      }
    }
    if (!stream && !buy) return null;
    return { stream, buy };
  } catch (e) { return null; }
}

// --- Main Results Rendering ---
async function runSearch(clear = false) {
  if (isLoading) return;
  isLoading = true;
  if (clear) {
    results = [];
    document.getElementById('mainResults').innerHTML = '';
    currentPage = 1; showMoreCount = 0;
  }
  let query = currentQuery, type = currentType;
  let batch = await fetchMedia(type, query, currentPage);
  let filtered = [];
  for (let item of batch) {
    let avail = await fetchAvailability(item.id, item.media_type || type, item.title || item.name);
    if (filterByProvider(avail)) {
      filtered.push({
        ...item,
        poster: item.poster_path ? `https://image.tmdb.org/t/p/w500${item.poster_path}` : '',
        availability: avail,
        title: item.title || item.name
      });
    }
    if (filtered.length >= 12) break;
  }
  results = results.concat(filtered);
  renderResults();
  isLoading = false;
}
function renderResults() {
  const container = document.getElementById('mainResults');
  container.innerHTML = '';
  results.forEach(item => {
    container.innerHTML += `
      <div class="bg-gray-800 p-4 rounded-lg shadow flex flex-col items-center">
        <img src="${item.poster}" alt="${item.title}" class="rounded mb-4" style="max-height:220px;object-fit:cover;">
        <h3 class="text-lg font-semibold">${item.title}</h3>
        <div class="text-sm text-gray-300">
          ${item.availability.stream ? `<div class='mt-2'>Stream on:<div class='flex flex-wrap justify-center'>${item.availability.stream}</div></div>` : ''}
          ${item.availability.buy ? `<div class='mt-4'>Buy on:<div class='flex flex-wrap justify-center'>${item.availability.buy}</div></div>` : ''}
        </div>
      </div>
    `;
  });
}
// --- Wild Cards Deck Feature ---
let wildCards = [], likedCards = [], wildIdx = 0;
function setupWildCards(arr) {
  wildCards = arr.slice(0,5); likedCards = []; wildIdx = 0;
  document.getElementById('wildArea').classList.remove('hidden');
  document.getElementById('mainResults').classList.add('hidden');
  document.getElementById('showMoreBtn').classList.add('hidden');
  renderWildCard();
}
function renderWildCard() {
  const stack = document.getElementById('wildStack');
  stack.innerHTML = '';
  if (wildIdx >= wildCards.length) {
    renderShortlist();
    return;
  }
  const card = wildCards[wildIdx];
  stack.innerHTML = `
    <div class="wild-card flipped" id="theWildCard">
      <img src="${card.poster}" alt="${card.title}" />
      <h3 class="text-lg font-bold mb-2">${card.title}</h3>
      <div class="mb-2">${card.availability.stream ? `<span class='text-green-300'>Stream on: ${card.availability.stream}</span>` : ''}</div>
      <div class="mb-2">${card.availability.buy ? `<span class='text-blue-300'>Buy on: ${card.availability.buy}</span>` : ''}</div>
      <div class="flex w-full justify-between mt-4">
        <div class="tick-x-btn" onclick="rejectWild()">❌</div>
        <div class="tick-x-btn" onclick="acceptWild()">✅</div>
      </div>
    </div>`;
}
function renderShortlist() {
  const row = document.getElementById('shortlistRow');
  row.innerHTML = '';
  likedCards.forEach((c, i) => {
    row.innerHTML += `<div class="shortlist-card" id="shortlist-${i}">
      <img src="${c.poster}" alt="${c.title}"/><div class="font-bold mt-2">${c.title}</div>
      <div class="flex justify-between w-full mt-1">
        <div class="tick-x-btn" onclick="removeShortlist(${i})">❌</div>
      </div>
    </div>`;
  });
  document.getElementById('wildStack').innerHTML = `<div class="text-lg text-pink-300 font-bold">Your Picks! (remove more until you're ready to decide)</div>`;
}
function rejectWild() { wildIdx++; renderWildCard(); }
function acceptWild() { likedCards.push(wildCards[wildIdx]); wildIdx++; renderWildCard(); }
function removeShortlist(idx) { likedCards.splice(idx,1); renderShortlist(); }

// --- Event Listeners & Initial Setup ---
document.addEventListener('DOMContentLoaded', function () {
  // Tab switching
  document.getElementById('allTab').onclick = () => { currentType = 'all'; setActiveTab(allTab); runSearch(true); };
  document.getElementById('movieTab').onclick = () => { currentType = 'movie'; setActiveTab(movieTab); runSearch(true); };
  document.getElementById('tvTab').onclick = () => { currentType = 'tv'; setActiveTab(tvTab); runSearch(true); };
  // Region buttons
  document.getElementById('regionUK').onclick = () => { currentRegion = 'GB'; setRegionButton(regionUK); runSearch(true); };
  document.getElementById('regionUS').onclick = () => { currentRegion = 'US'; setRegionButton(regionUS); runSearch(true); };
  document.getElementById('regionCA').onclick = () => { currentRegion = 'CA'; setRegionButton(regionCA); runSearch(true); };
  // Provider buttons
  document.getElementById('provider-netflix').onclick = function(){ toggleProvider('netflix', this); };
  document.getElementById('provider-prime').onclick = function(){ toggleProvider('prime', this); };
  document.getElementById('provider-disney').onclick = function(){ toggleProvider('disney', this); };
  document.getElementById('provider-hulu').onclick = function(){ toggleProvider('hulu', this); };
  document.getElementById('provider-apple').onclick = function(){ toggleProvider('apple', this); };
  // Search bar
  document.getElementById('searchInput').oninput = function(e) {
    currentQuery = e.target.value.trim();
    runSearch(true);
  };
  // Wild Cards Button
  document.getElementById('wildBtn').onclick = async function () {
    let media = await fetchMedia(currentType, '', 1);
    let cards = [];
    for (let m of media) {
      let avail = await fetchAvailability(m.id, m.media_type || currentType, m.title || m.name);
      if (filterByProvider(avail)) {
        cards.push({ ...m, poster: m.poster_path ? `https://image.tmdb.org/t/p/w500${m.poster_path}` : '', availability: avail, title: m.title || m.name });
        if (cards.length === 5) break;
      }
    }
    if (!cards.length) { alert("No wild cards available for your filters!"); return; }
    setupWildCards(cards);
  };
  // Show More Button
  document.getElementById('showMoreBtn').onclick = async function() {
    if (showMoreCount >= maxShowMore) { this.disabled = true; return; }
    currentPage++; showMoreCount++;
    await runSearch(false);
  };
  // Start initial search
  runSearch(true);
});
</script>
</body>
</html>





